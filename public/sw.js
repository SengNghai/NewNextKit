importScripts("/version.js");let t="my-cache-v"+self.PWA_VERSION,e="/api/domain",o="global-data-cache",a,i=0,n={currentDomain:"http://localhost:3000",anotherField:123},c=a=>JSON.stringify(a)!==JSON.stringify(n),s=a=>{"granted"!==Notification.permission?console.warn("No notification permission granted."):(console.log("data",a),self.registration.showNotification("Data Updated",{body:"New data is available!",icon:"/icon.png",data:{url:"https://your-website.com"}}))},l=async()=>{var a=await(await caches.open(o)).match("globalData");return a?(a=await a.json(),console.log("Retrieved global data from cache:",a),a):null},r=async a=>{await(await caches.open(o)).put("globalData",new Response(JSON.stringify(a))),console.log("Stored global data to cache:",a)},d=async()=>{try{var a;n=await l()||n,0===Object.keys(n).length&&(a=await fetch(e),n=await a.json(),await r(n)),console.log("Initializing global data:",n),(await self.clients.matchAll()).forEach(a=>{a.postMessage({type:"GLOBAL_DATA_INITIALIZE",data:n})})}catch(a){console.error("Error initializing global data:",a)}},g=async()=>{try{var a=await(await fetch(e)).json();c(a)&&(n=a,await r(n),s(a),i+=a.count||1,navigator.setAppBadge(i).catch(a=>{console.error("设置徽章失败:",a)}),(await self.clients.matchAll()).forEach(a=>{a.postMessage({type:"GLOBAL_DATA_UPDATE",data:n})}),console.log("接口数据是否发生变化--接口数据--后:",a))}catch(a){console.error("Error fetching data:",a)}},f=async()=>{console.log("Executing syncData function");try{var a=await fetch(e);200===a.status?(n=await a.json(),console.log("实现后台同步的函数 Data synced successfully:",n),s(n),(await self.clients.matchAll()).forEach(a=>{a.postMessage({type:"GLOBAL_DATA_UPDATE",data:n})})):console.warn("Empty response data")}catch(a){console.error("Error syncing data:",a)}},h=async()=>{"2025.03.02.161654"!==self.PWA_VERSION&&self.skipWaiting()},p=()=>{a=setInterval(g,3e5)},y=async()=>{try{await navigator.clearAppBadge()}catch(a){console.error("清除徽章失败:",a)}};self.addEventListener("push",a=>{var t,e;a.data&&(t=a.data.json(),console.log("data",t),e={body:t.body,icon:t.icon||"/icon.png",badge:"/badge.png",vibrate:[100,50,100],data:{dateOfArrival:Date.now(),primaryKey:t.primaryKey,url:t.url}},i+=t.count||1,navigator.setAppBadge(i).catch(a=>{console.error("设置徽章失败:",a)}),console.log("设置徽章数字",i),a.waitUntil(self.registration.showNotification(t.title,e)))}),self.addEventListener("notificationclick",a=>{console.log("Notification click received.",a),a.notification.close();let e=a.notification.data.url;a.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(a=>{for(var t of a)if(t.url.includes(self.location.origin)&&"navigate"in t)return t.navigate(e),t.focus();if(clients.openWindow)return clients.openWindow(e)})),y(),i=0}),self.addEventListener("activate",a=>{console.log("Service Worker activating."),a.waitUntil((async()=>{var a=await caches.keys();await Promise.all(a.map(a=>{if(a!==t)return caches.delete(a)})),await self.clients.claim(),await d(),p()})()),console.log("activate 事件处理程序已执行"),d()}),self.addEventListener("fetch",a=>{"navigate"===a.request.mode&&a.respondWith(fetch(a.request).catch(()=>caches.match("/index.html")))}),self.addEventListener("sync",a=>{console.log("Sync event triggered:",a.tag),"sync-data"===a.tag&&a.waitUntil(f())}),setInterval(h,36e5),self.addEventListener("message",a=>{a.data&&"GET_GLOBAL_DATA"===a.data.type&&a.ports[0].postMessage(n)});